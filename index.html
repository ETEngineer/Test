<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DST Visualization – CodeSandbox Dark (Fixed)</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#1e1f26; --panel:#2c2d35; --accent:#3ea6ff;
      --text:#e0e0e0; --subtext:#9aa0ac; --border:#3a3b44;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; background:var(--bg); color:var(--text);
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      display:flex; flex-direction:column; align-items:center; padding:14px;
    }
    h2{color:var(--accent); margin:8px 0 12px; font-size:1.15rem; text-align:center;}
    .controls{
      width:100%; max-width:720px; background:var(--panel); border:1px solid var(--border);
      padding:12px; border-radius:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      justify-content:center;
    }
    .controls input[type="file"]{padding:8px; color:var(--text); background:transparent; border:1px solid var(--border); border-radius:8px;}
    .controls label{color:var(--subtext); font-size:0.9rem; display:flex; gap:6px; align-items:center;}
    .controls input[type="date"]{padding:6px; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--text);}
    button{background:var(--accent); color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600;}
    button:hover{filter:brightness(1.08)}
    .chart-wrap{width:100%; max-width:1100px; margin-top:14px; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:10px;}
    canvas{width:100% !important; height:420px !important; display:block;}
    @media(max-width:600px){
      canvas{height:320px !important}
      .controls{padding:10px}
    }
    .note{color:var(--subtext); font-size:0.85rem; margin-top:8px; text-align:center;}
  </style>
</head>
<body>
  <h2>Calendar · ZonedDateTime · Canada/Central — DST Visualizer</h2>

  <div class="controls">
    <input id="fileInput" type="file" accept=".txt" />
    <label>From: <input id="startDate" type="date" /></label>
    <label>To: <input id="endDate" type="date" /></label>
    <button id="applyRange">Apply</button>
    <button id="resetRange" title="Show all">Reset</button>
  </div>

  <div class="chart-wrap">
    <canvas id="timeChart"></canvas>
  </div>

  <div class="note">Upload your <code>timeData.txt</code> (three comma columns per row). Y axis shows local time (HH:mm).</div>

<script>
(() => {
  const fileInput = document.getElementById('fileInput');
  const applyRange = document.getElementById('applyRange');
  const resetRange = document.getElementById('resetRange');
  const startDateInput = document.getElementById('startDate');
  const endDateInput = document.getElementById('endDate');
  const ctx = document.getElementById('timeChart').getContext('2d');

  let rawRows = [];    // [{calendarStr, calDt, zonDt, centralDt, xLabel, calTs, zonTs, cenTs}]
  let chart = null;

  // safe parser: skip empty lines & trim
  function parseText(txt){
    const lines = txt.split(/\r?\n/).map(l => l.trim()).filter(l => l && l.split(',').length >= 3);
    const arr = lines.map(line => {
      const parts = line.split(',').map(p => p.trim());
      const calStr = parts[0];
      const zonStr = parts[1];
      const cenStr = parts[2];
      const calDt = new Date(calStr);
      const zonDt = new Date(zonStr);
      const cenDt = new Date(cenStr);
      return {
        calendarStr: calStr,
        calDt, zonDt, cenDt,
        // x label (human friendly): use locale string of calendar (keeps ordering)
        xLabel: calDt.toLocaleString(),
        // numeric timestamps (ms) for y-values
        calTs: calDt.getTime(),
        zonTs: zonDt.getTime(),
        cenTs: cenDt.getTime()
      };
    });
    return arr;
  }

  fileInput.addEventListener('change', evt => {
    const f = evt.target.files && evt.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        rawRows = parseText(reader.result || '');
        if(rawRows.length === 0) {
          alert('No valid rows found in the file. Make sure each line has 3 comma-separated columns.');
          return;
        }
        // auto-fill date inputs using first/last calendar date (in yyyy-mm-dd)
        const first = rawRows[0].calDt;
        const last = rawRows[rawRows.length - 1].calDt;
        startDateInput.value = first.toISOString().slice(0,10);
        endDateInput.value = last.toISOString().slice(0,10);
        drawChart(rawRows);
      } catch(err){
        console.error(err);
        alert('Error parsing file. See console for details.');
      }
    };
    reader.readAsText(f);
  });

  applyRange.addEventListener('click', () => {
    if(rawRows.length === 0) return;
    const s = startDateInput.value ? new Date(startDateInput.value + 'T00:00:00') : null;
    const e = endDateInput.value ? new Date(endDateInput.value + 'T23:59:59.999') : null;
    const filtered = rawRows.filter(r => (!s || r.calDt >= s) && (!e || r.calDt <= e));
    drawChart(filtered);
  });

  resetRange.addEventListener('click', () => {
    if(rawRows.length === 0) return;
    startDateInput.value = rawRows[0].calDt.toISOString().slice(0,10);
    endDateInput.value = rawRows[rawRows.length - 1].calDt.toISOString().slice(0,10);
    drawChart(rawRows);
  });

  function drawChart(rows){
    if(chart) chart.destroy();

    // x labels keep chronological order
    const labels = rows.map(r => r.xLabel);

    // datasets: y are numeric timestamps (ms)
    const calendarData = rows.map((r,i) => ({ x: labels[i], y: r.calTs }));
    const zonedData    = rows.map((r,i) => ({ x: labels[i], y: r.zonTs }));
    const centralData  = rows.map((r,i) => ({ x: labels[i], y: r.cenTs }));

    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels, // category labels (x)
        datasets: [
          { label: 'Calendar Time', data: calendarData, borderColor: '#ff6b81', borderWidth:2, pointRadius:0, tension:0.25 },
          { label: 'ZonedDateTime', data: zonedData, borderColor: '#3ea6ff', borderWidth:2, pointRadius:0, tension:0.25 },
          { label: 'Canada/Central Converted', data: centralData, borderColor: '#4ad991', borderWidth:2, pointRadius:0, tension:0.25 }
        ]
      },
      options: {
        parsing: { xAxisKey: 'x', yAxisKey: 'y' }, // ensure Chart reads x/y from objects
        plugins: {
          legend: { labels: { color: '#ddd' }, position: 'top' },
          title: { display:true, text:'DST Visualization', color:'#3ea6ff', font:{size:16,weight:'600'} },
          tooltip: {
            backgroundColor:'#2a2a33', titleColor:'#fff', bodyColor:'#ddd',
            callbacks: {
              title: items => items[0]?.label || '',
              label: ctx => {
                // ctx.raw.y is timestamp (ms). convert to readable local datetime
                const ts = ctx.raw && ctx.raw.y ? ctx.raw.y : ctx.parsed.y;
                const dt = new Date(ts);
                return `${ctx.dataset.label}: ${dt.toLocaleString()}`;
              }
            }
          }
        },
        responsive:true,
        maintainAspectRatio:false,
        scales: {
          x: {
            type:'category',
            title: { display:true, text:'Timeline (Calendar)', color:'#b0b0b0' },
            ticks: { color:'#ccc', maxRotation:45, autoSkip:true, maxTicksLimit:12 },
            grid: { color:'rgba(255,255,255,0.04)' }
          },
          y: {
            type:'linear',
            title: { display:true, text:'Local Time (HH:mm)', color:'#b0b0b0' },
            ticks: {
              color:'#ccc',
              callback: val => {
                // val is numeric timestamp in ms
                if(!val) return '';
                const d = new Date(Number(val));
                return d.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
              },
              maxTicksLimit:9
            },
            grid: { color:'rgba(255,255,255,0.04)' }
          }
        },
        elements:{ line:{ fill:false } }
      }
    });
  }

  // small helpful console message
  console.log('DST visualizer ready. Upload your timeData.txt (3 columns per row: calendar,zoned,canCentral).');

})();
</script>
</body>
</html>
